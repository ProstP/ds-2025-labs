# PA7. Тестирование распределённой системы

**Цель:** научиться выполнять автоматизированное тестирование системы, состоящей из нескольких сервисов и промежуточного ПО (СУБД, брокеры и так далее).

- Задание делается на базе задания PA4, PA5 либо PA6 (на выбор)
- Это необязательная лабораторная — вы можете выбирать или не выбирать её на своё усмотрение

# Задание

Лабораторная содержит два задания. Для сдачи лабораторной вы должны выполнить оба.

## Уровни тестирования

Автоматизированные тесты в распределённой системе можно разделить на три уровня:

1. **Модульные** тесты (unit tests) — тестируют один модуль, где модуль может быть небольшого (класс или файл с кодом) или среднего размера (пакет или каталог файлов с кодом)
2. **Интеграционные** тесты (integration tests), также называемые компонентными (component tests) — тестируют один сервис (компонент) вместе с его управляемыми зависимостями (СУБД, хранилище файлов и так далее)
3. **Сквозные** тесты (end-to-end tests), также называемые UI-тестами — тестируют всю систему целиком путём эмуляции действий пользователя, зачастую используя Selenium + WebDriver для управления браузером из тестов

Как интеграционные, так и сквозные тесты могут служить в роли **приёмочных** тестов — то есть тестов, проверяющих соответствие программы спецификации и ожиданиям заказчиков/клиентов/пользователей:

- если в роли приёмочных тестов используются интеграционные, то команда разработки может покрывать тестами **контракт** (то есть API) сервиса и предполагать, что при соблюдении контрактов успешное прохождение тестов означает работоспособность системы в целом
- если в роли приёмочных тестов используются сквозные, то тестовые сценарии не зависят напрямую от способа декомпозиции системы на сервисы (микросервисы), и прохождение сквозных тестов означает работоспособность системы в целом

В рамках лабораторной вы в минимальном объёме реализуете модульные и приёмочные тесты (интеграционные или сквозные).

## Задание 1. Модульный тест

Напишите модульный тест, проверяющий алгоритм расчёта rank

- **Перед** написанием тестов напишите список будущих тестов в отдельном файле, например `docs/rank-tests.md` или `docs/rank-tests.txt`. Этот список надо будет показать при сдаче проекта.
- Набор тестов можно придумать самостоятельно либо спросить об этом LLM (GPT)

Для C# рекомендуется использовать фреймворк XUnit, для Go — встроенный пакет `"testing"`.

Бонусы:

- **Бонус +1 балл** даётся, если вы используете параметризованные тесты с `Theory` и `TheoryData`, а в списке тестов есть тест на правильную обработку Emoji (один emoji = один символ Unicode).

## Задание 2. Приёмочные тесты (сквозные либо интеграционные)

Следует написать приёмочные тесты, проверяющих функциональность сервиса. Вы должны выбрать между интеграционными и сквозными тестами.

### Вариант 2.1. Интеграционные тесты

Вы должны проверить интеграционными тестами два сценария:

1. Основной сценарий системы — отправка текста на проверку компонентом Valuator.
2. Другой важный сценарий — вычисление Rank компонентом RankCalculator.

Таким образом, у вас будет два интеграционных теста для двух _различных_ компонентов системы.

Бонусы:

- **Бонус +2 балла** даётся за использование языка Gherkin при описании тестов
- **Бонус +1 балл** даётся за использование TestContainers при запуске Redis

Требования к интеграционным тестам:

1. Написаны на том же языке, что и тестируемый сервис (компонент)
2. Проверяют один сервис (компонент) в изоляции от остальных
3. RabbitMQ / Nats заменяется на тестовый дублёр (Fake/Mock/Stub)
4. Redis используется как есть без замены на тестовый дублёр (Fake/Mock/Stub)
     - для изоляции тестов можно запускать новый экземпляр Redis в Docker на каждый тест с помощью библиотеки TestContainers

Дополнительные требования для C#:

1. Следует использовать пакет `Microsoft.AspNetCore.Mvc.Testing` (примеры есть в статье ниже)
2. Интеграционные тесты каждого компонента должны быть в отдельных C# проектах
    - пример: `tests/Valuator.IntegrationTests/`, `tests/RankCalculator.IntegrationTests/`
    - другой пример: `tests/Valuator.Specs/`, `tests/RankCalculator.Specs/` — подойдёт, если вы используете Gherkin
3. Если вы используете Gherkin, используйте Reqnroll и учтите правила из статьи [Gherkin Reference](https://docs.reqnroll.net/latest/gherkin/gherkin-reference.html)

### Вариант 2.2 Сквозные тесты

Вы должны проверить сквозными тестами один сценарий: отправка текста на проверку и ожидание результата, затем проверка результат (rank).

Таким образом, у вас будет один сквозной тест, проверяющий один сценарий, в котором участвуют два компонента системы — Valuator и RankCalculator.

Бонусы:

- **Бонус +2 балла** даётся за использование языка Gherkin при описании тестов
- **Бонус +1 балл** даётся за использование docker compose при запуске тестируемой системы со всеми её компонентами

Требования к сквозным тестам:

1. Написаны на C# для проектов на C#, на любом удобном языке для проектов на Go
2. Проверяют всю систему, в которой развёрнуты все сервисы и всё промежуточное ПО (Redis, RabbitMQ / Nats)
3. Нет никаких тестовых дублёров (Fake/Mock/Stub)

Дополнительные требования для C#:

1. Следует использовать пакет [Selenium.WebDriver](https://www.nuget.org/packages/Selenium.WebDriver)
2. Сквозные тесты должны быть в отдельном C# проекте
    - пример: `tests/System.E2ETests/`
    - другой пример: `tests/System.Specs/` — подойдёт, если вы используете Gherkin
3. Если вы используете Gherkin, используйте Reqnroll и учтите правила из статьи [Gherkin Reference](https://docs.reqnroll.net/latest/gherkin/gherkin-reference.html)

## Ссылки

### Модульные тесты

- C#: [Getting Started with xUnit.net](https://xunit.net/docs/getting-started/v2/netfx/visual-studio)
- C#: [Creating strongly typed xUnit theory test data with TheoryData](https://andrewlock.net/creating-strongly-typed-xunit-theory-test-data-with-theorydata/)
- C#: [Creating Data-Driven Tests With xUnit](https://www.milanjovanovic.tech/blog/creating-data-driven-tests-with-xunit)
- Go: [Add a test](https://go.dev/doc/tutorial/add-a-test)

### Интеграционные тесты

- C#: [Интеграционные тесты для ASP.NET Core](https://habr.com/ru/articles/860932/)
- C#: [Test Doubles в интеграционных тестах на ASP.NET Core](https://habr.com/ru/articles/871614/)
- C#: [Gherkin Reference / Reqnroll](https://docs.reqnroll.net/latest/gherkin/gherkin-reference.html)
- C#: [Getting started with Testcontainers for .NET](https://testcontainers.com/guides/getting-started-with-testcontainers-for-dotnet/)
- Redis: [TestContainers Redis Module](https://testcontainers.com/modules/redis/)

### Приёмочные тесты

- C#: [Install a Selenium library](https://www.selenium.dev/documentation/webdriver/getting_started/install_library/)
- C#: [Using Page Object Model](https://docs.reqnroll.net/latest/guides/page-object-model.html)



